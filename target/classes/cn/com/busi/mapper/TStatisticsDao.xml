<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.busi.mapper.TStatisticsDao">

    <resultMap id="GetResultMap" type="java.util.Map">
        <!--@Table t_report-->
        <result property="id" column="id" jdbcType="VARCHAR"/>
        <result property="cllx" column="cllx" jdbcType="VARCHAR"/>
        <result property="ppxh" column="ppxh" jdbcType="VARCHAR"/>
        <result property="xzqy" column="xzqy" jdbcType="VARCHAR"/>
        <result property="hgl" column="hgl" jdbcType="VARCHAR"/>
        <result property="clrllb" column="clrllb" jdbcType="VARCHAR"/>
        <result property="jcjgmc" column="jcjgmc" jdbcType="VARCHAR"/>
        <result property="jcjl" column="jcjl" jdbcType="VARCHAR"/>
        <result property="jcrq" column="jcrq" jdbcType="VARCHAR"/>
        <result property="clzs" column="clzs" jdbcType="VARCHAR"/>
        <result property="singlePass" column="singlePass" jdbcType="VARCHAR"/>
        <result property="num" column="num" jdbcType="VARCHAR"/>
        <result property="table" column="table" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="BaseResultMap" type="cn.com.busi.entity.TStatistics">
        <!--@Table t_report-->
        <result property="id" column="id" jdbcType="VARCHAR"/>
        <result property="cllx" column="cllx" jdbcType="VARCHAR"/>
        <result property="ppxh" column="ppxh" jdbcType="VARCHAR"/>
        <result property="xzqy" column="xzqy" jdbcType="VARCHAR"/>
        <result property="hgl" column="hgl" jdbcType="VARCHAR"/>
        <result property="clrllb" column="clrllb" jdbcType="VARCHAR"/>
        <result property="jcjgmc" column="jcjgmc" jdbcType="VARCHAR"/>
        <result property="jcjl" column="jcjl" jdbcType="VARCHAR"/>
        <result property="jcrq" column="jcrq" jdbcType="VARCHAR"/>
        <result property="clzs" column="clzs" jdbcType="VARCHAR"/>
        <result property="singlePass" column="singlePass" jdbcType="VARCHAR"/>
        <result property="num" column="num" jdbcType="VARCHAR"/>
        <result property="table" column="table" jdbcType="VARCHAR"/>
    </resultMap>

    <!--车辆总数查询-->
    <select id="carAll" resultMap="BaseResultMap">
        select
        COUNT(*) as clzs
        <trim prefix="," suffixOverrides=",">
            <if test="tStatistics.xzqy != null and tStatistics.xzqy != ''">
                ${tStatistics.xzqy},
            </if>
            <if test="tStatistics.cllx != null and tStatistics.cllx != ''">
                ${tStatistics.cllx},
            </if>
            <if test="tStatistics.ppxh != null and tStatistics.ppxh != ''">
                ${tStatistics.ppxh},
            </if>
            <if test="tStatistics.clrllb != null and tStatistics.clrllb != ''">
                ${tStatistics.clrllb},
            </if>
            <if test="tStatistics.jcjgmc != null and tStatistics.jcjgmc != ''">
                ${tStatistics.jcjgmc},
            </if>
            <if test="tStatistics.jcjl != null and tStatistics.jcjl != ''">
                ${tStatistics.jcjl},
            </if>
            <if test="tStatistics.jcrq != null">
                ${tStatistics.jcrq},
            </if>
        </trim>
        from t_report
        <where>
            <if test="tReport.xzqy != null and tReport.xzqy != ''">
                and xzqy like concat(concat('%',#{tReport.xzqy}),'%')
            </if>
            <if test="tReport.cllx != null and tReport.cllx != ''">
                and cllx like concat(concat('%',#{tReport.cllx}),'%')
            </if>
            <if test="tReport.ppxh != null and tReport.ppxh != ''">
                and ppxh like concat(concat(#{tReport.ppxh}),'%')
            </if>
            <if test="tReport.jcjgmc != null and tReport.jcjgmc != ''">
                and jcjgmc like concat(concat('%',#{tReport.jcjgmc}),'%')
            </if>
            <if test="tReport.clrllb != null and tReport.clrllb != ''">
                and clrllb like concat(concat('%',#{tReport.clrllb}),'%')
            </if>
            <if test="tReport.jcjl != null and tReport.jcjl != ''">
                and jcjl = #{tReport.jcjl}
            </if>
            <if test="tStatistics.startDate != null">
                and TO_DAYS(jcrq) &gt;= TO_DAYS(#{tStatistics.startDate})
            </if>
            <if test="tStatistics.endDate != null">
                and TO_DAYS(jcrq) &lt;= TO_DAYS(#{tStatistics.endDate})
            </if>
        </where>
        <trim prefix="group by" suffixOverrides=",">
            <if test="tStatistics.xzqy != null and tStatistics.xzqy != ''">
                ${tStatistics.xzqy},
            </if>
            <if test="tStatistics.cllx != null and tStatistics.cllx != ''">
                ${tStatistics.cllx},
            </if>
            <if test="tStatistics.clrllb != null and tStatistics.clrllb != ''">
                ${tStatistics.clrllb},
            </if>
            <if test="tStatistics.jcjgmc != null and tStatistics.jcjgmc != ''">
                ${tStatistics.jcjgmc},
            </if>
            <if test="tStatistics.jcjl != null and tStatistics.jcjl != ''">
                ${tStatistics.jcjl},
            </if>

        </trim>
    </select>

    <!--初审合格率查询-->
    <select id="firstSelect" resultMap="BaseResultMap">
        select
        COUNT(case when jcjl !='不合格' then 1 else null end)/COUNT(*) as hgl
        <trim prefix="," suffixOverrides=",">
            <if test="tStatistics.xzqy != null and tStatistics.xzqy != ''">
                ${tStatistics.xzqy},
            </if>
            <if test="tStatistics.cllx != null and tStatistics.cllx != ''">
                ${tStatistics.cllx},
            </if>
            <if test="tStatistics.ppxh != null and tStatistics.ppxh != ''">
                ${tStatistics.ppxh},
            </if>
            <if test="tStatistics.clrllb != null and tStatistics.clrllb != ''">
                ${tStatistics.clrllb},
            </if>
            <if test="tStatistics.jcjgmc != null and tStatistics.jcjgmc != ''">
                ${tStatistics.jcjgmc},
            </if>
            <if test="tStatistics.jcrq != null">
                ${tStatistics.jcrq},
            </if>
        </trim>
        from t_report
        <where>
            zjcs = "1"
            <if test="tReport.xzqy != null and tReport.xzqy != ''">
                and xzqy like concat(concat('%',#{tReport.xzqy}),'%')
            </if>
            <if test="tReport.cllx != null and tReport.cllx != ''">
                and cllx like concat(concat('%',#{tReport.cllx}),'%')
            </if>
            <if test="tReport.ppxh != null and tReport.ppxh != ''">
                and ppxh like concat(concat(#{tReport.ppxh}),'%')
            </if>
            <if test="tReport.jcjgmc != null and tReport.jcjgmc != ''">
                and jcjgmc like concat(concat('%',#{tReport.jcjgmc}),'%')
            </if>
            <if test="tReport.clrllb != null and tReport.clrllb != ''">
                and clrllb like concat(concat('%',#{tReport.clrllb}),'%')
            </if>
            <if test="tReport.jcjl != null and tReport.jcjl != ''">
                and jcjl like concat(concat('%',#{tReport.jcjl}),'%')
            </if>
            <if test="tStatistics.startDate != null">
                and TO_DAYS(jcrq) &gt;= TO_DAYS(#{tStatistics.startDate})
            </if>
            <if test="tStatistics.endDate != null">
                and TO_DAYS(jcrq) &lt;= TO_DAYS(#{tStatistics.endDate})
            </if>
        </where>
        <trim prefix="group by" suffixOverrides=",">
            <if test="tStatistics.xzqy != null and tStatistics.xzqy != ''">
                ${tStatistics.xzqy},
            </if>
            <if test="tStatistics.cllx != null and tStatistics.cllx != ''">
                ${tStatistics.cllx},
            </if>
            <if test="tStatistics.clrllb != null and tStatistics.clrllb != ''">
                ${tStatistics.clrllb},
            </if>
            <if test="tStatistics.jcjgmc != null and tStatistics.jcjgmc != ''">
                ${tStatistics.jcjgmc},
            </if>
            <if test="tStatistics.jcjl != null and tStatistics.jcjl != ''">
                ${tStatistics.jcjl},
            </if>

        </trim>
    </select>

    <!--单项合格率查询查询-->
    <select id="singleSelect" resultMap="BaseResultMap">
        select
        COUNT(case when ${tStatistics.singlePass} !='不合格' AND ${tStatistics.singlePass} !='-' AND ${tStatistics.singlePass} !='' then 1 else null
        end)/COUNT(*) as hgl
        <trim prefix="," suffixOverrides=",">
            <if test="tStatistics.xzqy != null and tStatistics.xzqy != ''">
                ${tStatistics.xzqy},
            </if>
            <if test="tStatistics.cllx != null and tStatistics.cllx != ''">
                ${tStatistics.cllx},
            </if>
            <if test="tStatistics.ppxh != null and tStatistics.ppxh != ''">
                ${tStatistics.ppxh},
            </if>
            <if test="tStatistics.clrllb != null and tStatistics.clrllb != ''">
                ${tStatistics.clrllb},
            </if>
            <if test="tStatistics.jcjgmc != null and tStatistics.jcjgmc != ''">
                ${tStatistics.jcjgmc},
            </if>
            <if test="tStatistics.jcjl != null and tStatistics.jcjl != ''">
                ${tStatistics.jcjl},
            </if>
            <if test="tStatistics.jcrq != null ">
                ${tStatistics.jcrq},
            </if>
        </trim>
        from t_report
        <where>
            <if test="tReport.xzqy != null and tReport.xzqy != ''">
                and xzqy like concat(concat('%',#{tReport.xzqy}),'%')
            </if>
            <if test="tReport.cllx != null and tReport.cllx != ''">
                and cllx like concat(concat('%',#{tReport.cllx}),'%')
            </if>
            <if test="tReport.ppxh != null and tReport.ppxh != ''">
                and ppxh like concat(concat(#{tReport.ppxh}),'%')
            </if>
            <if test="tReport.jcjgmc != null and tReport.jcjgmc != ''">
                and jcjgmc like concat(concat('%',#{tReport.jcjgmc}),'%')
            </if>
            <if test="tReport.clrllb != null and tReport.clrllb != ''">
                and clrllb like concat(concat('%',#{tReport.clrllb}),'%')
            </if>
            <if test="tStatistics.startDate != null ">
                and TO_DAYS(jcrq) &gt;= TO_DAYS(#{tStatistics.startDate})
            </if>
            <if test="tStatistics.endDate != null ">
                and TO_DAYS(jcrq) &lt;= TO_DAYS(#{tStatistics.endDate})
            </if>
        </where>
        <trim prefix="group by" suffixOverrides=",">
            <if test="tStatistics.xzqy != null  and tStatistics.xzqy != ''">
                ${tStatistics.xzqy},
            </if>
            <if test="tStatistics.cllx != null  and tStatistics.cllx != ''">
                ${tStatistics.cllx},
            </if>
            <if test="tStatistics.clrllb != null  and tStatistics.clrllb != ''">
                ${tStatistics.clrllb},
            </if>
            <if test="tStatistics.jcjgmc != null  and tStatistics.jcjgmc != ''">
                ${tStatistics.jcjgmc},
            </if>


        </trim>
    </select>


    <select id="cllxStatistics" resultMap="GetResultMap">
        SELECT count(1) num,cllx FROM t_report  GROUP BY cllx
    </select>


    <select id="firstStatistics" resultType="java.lang.Integer">
        SELECT
	        count(t_report.jcjl) AS num
        FROM
	        (
            select year(Now())-2 as years
            union
            select year(Now())-1 as years
            union
            select year(Now()) as years
	        ) AS years
        LEFT JOIN t_report ON YEAR(jcrq) = years.years and  t_report.jcjl !="不合格" and t_report.zjcs = "1"
        GROUP BY
	        years.years
    </select>

    <select id="firstNotStatistics" resultType="java.lang.Integer">
        SELECT
	        count(t_report.jcjl) AS num
        FROM
	        (
            select year(Now())-2 as years
            union
            select year(Now())-1 as years
            union
            select year(Now()) as years
	        ) AS years
        LEFT JOIN t_report ON YEAR(jcrq) = years.years and  t_report.jcjl ="不合格" and t_report.zjcs = "1"
        GROUP BY
	        years.years
    </select>

    <select id="count" resultType="java.lang.Integer" statementType="PREPARED">
        SELECT
	        count(*) AS num
        FROM
            ${table}
    </select>

    <!-- 单项合格数量统计 -->
    <select id="singleStatistics" resultType="java.lang.Integer">
        SELECT
	        count(${tSintype.id}) AS num
        FROM
	        (
            select year(Now())-2 as years
            union
            select year(Now())-1 as years
            union
            select year(Now()) as years
	        ) AS years
        LEFT JOIN t_report ON YEAR(jcrq) = years.years and ${tSintype.id} != "不合格" and ${tSintype.id} != "-"  and ${tSintype.id} !=""
        GROUP BY
	        years.years
    </select>
</mapper>